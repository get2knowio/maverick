# =============================================================================
# Validate Workflow
# =============================================================================
#
# Purpose:
#   Execute validation stages with optional automatic fixes. This workflow
#   validates code quality through format, lint, type checking, and testing,
#   with configurable retry logic to automatically fix validation failures.
#
# Inputs:
#   - fix (boolean, optional, default: true)
#     Enable automatic fix attempts when validation stages fail. When true,
#     the workflow invokes a fixer agent to resolve issues before retrying.
#
#   - max_attempts (integer, optional, default: 3)
#     Maximum number of fix-and-retry attempts for failed validation stages.
#     Must be >= 0. Set to 0 to disable retry logic entirely.
#
# Step Summary:
#   1. run_validation: Execute all validation stages (format, lint, typecheck, test)
#   2. fix_loop: (conditional) If fix=true and validation fails, attempt fixes
#      and retry validation up to max_attempts times
#   3. report: Generate final validation summary with pass/fail status
#
# Customization Points:
#   - Modify stages array in run_validation step to customize which checks run
#   - Adjust max_attempts to control retry behavior
#   - Override the validate_and_fix fragment to change fix agent behavior
#   - Add custom validation stages by modifying the stages list
#   - Insert pre-validation setup steps before run_validation
#   - Add post-validation cleanup steps after report
#
# Example Usage:
#   # Run with default settings (auto-fix enabled, 3 max attempts)
#   maverick workflow run validate
#
#   # Run validation only, no fixes
#   maverick workflow run validate --input fix=false
#
#   # Run with increased retry attempts
#   maverick workflow run validate --input max_attempts=5
#
#   # Run specific stages only (requires fragment override)
#   maverick workflow run validate --input fix=false
#
# =============================================================================

version: "1.0"
name: validate
description: Validation with optional fixes workflow

inputs:
  fix:
    type: boolean
    required: false
    default: true
    description: Attempt automatic fixes when validation stages fail

  max_attempts:
    type: integer
    required: false
    default: 3
    description: Maximum fix attempts (0 disables retry logic)

steps:
  # ---------------------------------------------------------------------------
  # Step 1: Run Initial Validation
  # ---------------------------------------------------------------------------
  # Execute all validation stages in sequence. If all stages pass, the
  # workflow proceeds directly to the report step. If any stage fails,
  # control passes to the fix_loop step (if fix=true) or directly to report.
  #
  # Stages executed:
  #   - format: Code formatting (e.g., ruff format, black)
  #   - lint: Linting rules (e.g., ruff check, pylint)
  #   - typecheck: Type checking (e.g., mypy)
  #   - test: Test suite execution (e.g., pytest)
  #
  # Customization: Override the stages array to run a subset of checks or
  # add custom validation stages supported by your ValidationRunner.
  # ---------------------------------------------------------------------------
  - name: run_validation
    type: validate
    stages: ["format", "lint", "typecheck", "test"]
    retry: 0  # No automatic retry at this level; retry is handled by fix_loop

  # ---------------------------------------------------------------------------
  # Step 2: Fix Loop (Conditional)
  # ---------------------------------------------------------------------------
  # When fix=true and run_validation fails, invoke the validate_and_fix
  # fragment to attempt automatic repairs and retry validation. This fragment
  # implements a retry loop with the following behavior:
  #
  #   1. Invoke fixer agent to analyze failures and apply fixes
  #   2. Re-run validation stages
  #   3. Repeat up to max_attempts times or until validation passes
  #
  # The fragment yields progress updates for each fix attempt, enabling
  # real-time visibility into the fix process.
  #
  # Customization: Override the validate_and_fix fragment to:
  #   - Use a custom fixer agent (validation_fixer by default)
  #   - Modify fix logic (e.g., apply fixes in parallel)
  #   - Add pre-fix validation or post-fix cleanup
  #   - Change retry backoff strategy
  # ---------------------------------------------------------------------------
  - name: fix_loop
    type: branch
    options:
      # Branch 1: Validation passed, skip fix loop
      - when: ${{ steps.run_validation.output.passed }}
        step:
          name: skip_fixes
          type: python
          action: log_message
          kwargs:
            message: "Validation passed on first attempt, no fixes needed"

      # Branch 2: Validation failed but fix is disabled
      - when: ${{ not inputs.fix }}
        step:
          name: skip_fixes_disabled
          type: python
          action: log_message
          kwargs:
            message: "Validation failed but fix=false, skipping fix attempts"

      # Branch 3: Validation failed and fix is enabled, invoke fix fragment
      # (Previous branches handled passed validation and fix=false)
      - when: ${{ inputs.fix }}
        step:
          name: attempt_fixes
          type: subworkflow
          workflow: validate-and-fix
          inputs:
            stages: ["format", "lint", "typecheck", "test"]
            max_attempts: ${{ inputs.max_attempts }}
            fixer_agent: validation_fixer

  # ---------------------------------------------------------------------------
  # Step 3: Generate Validation Report
  # ---------------------------------------------------------------------------
  # Produce a final summary of validation results, including:
  #   - Overall pass/fail status
  #   - Per-stage results (passed/failed/skipped)
  #   - Number of fix attempts made (if applicable)
  #   - Error messages for failed stages
  #   - Suggestions for manual fixes (if auto-fix failed)
  #
  # The report is returned as the workflow output and can be consumed by:
  #   - TUI for display in the validation results panel
  #   - CLI for terminal output formatting
  #   - Downstream workflows (e.g., fly workflow validation phase)
  #
  # Customization: Replace this Python step with a custom report generator
  # to change output format, add metrics, or integrate with external systems
  # (e.g., send results to a monitoring service).
  # ---------------------------------------------------------------------------
  - name: report
    type: python
    action: generate_validation_report
    kwargs:
      initial_result: ${{ steps.run_validation.output }}
      fix_result: ${{ steps.fix_loop.output }}
      fix_enabled: ${{ inputs.fix }}
      max_attempts: ${{ inputs.max_attempts }}

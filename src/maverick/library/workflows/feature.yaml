# ==============================================================================
# Feature Workflow - Speckit-Based Development
# ==============================================================================
#
# The "feature" workflow orchestrates a complete feature implementation from a
# speckit task list through to pull request creation. This workflow is designed
# for speckit-based development and expects a properly structured tasks.md with
# phases.
#
# PREREQUISITES:
#   This workflow expects a speckit project structure:
#   - specs/<branch-name>/tasks.md with phase markers (## Phase: Setup, etc.)
#   - specs/<branch-name>/plan.md with technical design
#   - Optional: spec.md, data-model.md, contracts/, checklists/
#
# WORKFLOW STAGES:
#   1. Preflight: Validate tools and credentials
#   2. Init: Workspace initialization and branch sync
#   3. Implement: Execute tasks phase-by-phase from tasks.md
#   4. Validate: Run validation after each phase with fix retry loop
#   5. Commit: Commit after each phase, final push after all phases
#   6. Review: Dual-agent code review (spec + technical)
#   7. Create PR: Generate PR body and create pull request
#
# INPUTS:
#   - branch_name (string, required): Feature branch name
#       The Git branch to work on. Will be created or checked out.
#       Example: "025-builtin-workflow-library"
#
#   - task_file (string, optional): Path to tasks.md file
#       Location of the task list to execute. If omitted, workflow will
#       auto-detect: specs/<branch-name>/tasks.md
#
#   - skip_review (boolean, optional, default: false): Skip code review stage
#       Set to true to bypass the code review step.
#
#   - dry_run (boolean, optional, default: false): Preview mode
#       Set to true to preview workflow actions without executing them.
#
# EXAMPLE USAGE:
#   maverick fly feature -i branch_name=025-builtin-workflow-library
#
# ==============================================================================

version: "1.0"
name: feature
description: Speckit-based feature development workflow

# ------------------------------------------------------------------------------
# Input Declarations
# ------------------------------------------------------------------------------
inputs:
  branch_name:
    type: string
    required: true
    description: Feature branch name (matches specs/<branch-name>/ directory)

  task_file:
    type: string
    required: false
    description: |
      Path to tasks.md (auto-detect from specs/<branch-name>/tasks.md if omitted)

  skip_review:
    type: boolean
    required: false
    default: false
    description: Skip code review stage

  dry_run:
    type: boolean
    required: false
    default: false
    description: Preview workflow actions without executing them

# ------------------------------------------------------------------------------
# Workflow Steps
# ------------------------------------------------------------------------------
steps:
  # ============================================================================
  # Stage 0: Preflight Checks
  # ============================================================================
  # Validate that all required tools and credentials are available before
  # starting the workflow.
  # ============================================================================
  - name: preflight
    type: python
    action: run_preflight_checks
    kwargs:
      check_api: true
      check_git: true
      check_github: true
      check_validation_tools: true
      validation_stages:
        - format
        - lint
        - test
      fail_on_error: true
    metadata:
      progress:
        stage: "preflight"
        weight: 2

  # ============================================================================
  # Stage 1: Workspace Initialization
  # ============================================================================
  # Initialize the workspace by syncing the feature branch with the base branch,
  # ensuring we're starting from a clean, up-to-date state.
  #
  # Note: Preflight step now fails hard on errors (fail_on_error=true by default),
  # so we only reach this step if preflight passed.
  # ============================================================================
  - name: init
    type: python
    action: init_workspace
    when: ${{ not inputs.dry_run }}
    kwargs:
      branch_name: ${{ inputs.branch_name }}
    metadata:
      progress:
        stage: "initialization"
        weight: 5

  # ============================================================================
  # Stage 2: Get Phase Names
  # ============================================================================
  # Extract phase names from tasks.md to enable phase-level iteration.
  # Speckit tasks.md files contain phases like "## Phase: Setup", "## Phase: Core".
  # ============================================================================
  - name: get_phases
    type: python
    action: get_phase_names
    when: ${{ not inputs.dry_run and steps.init.output.task_file_path }}
    kwargs:
      task_file: ${{ inputs.task_file or steps.init.output.task_file_path }}
    metadata:
      progress:
        stage: "initialization"
        weight: 2

  # ============================================================================
  # Stage 3: Implementation by Phase
  # ============================================================================
  # Execute tasks phase-by-phase using the Implementer agent.
  #
  # For each phase:
  # - Execute all tasks (Claude handles [P] parallelization)
  # - Validate (format, lint, typecheck, test)
  # - Commit phase changes
  # - Checkpoint for resume capability
  #
  # The implementer invokes /speckit.implement which handles:
  # - Prerequisites check
  # - Checklist verification
  # - Loading spec artifacts (plan.md, data-model.md, etc.)
  # - TDD-based task execution
  # ============================================================================
  - name: implement_by_phase
    type: loop
    when: ${{ not inputs.dry_run and steps.get_phases.output }}
    for_each: ${{ steps.get_phases.output }}
    steps:
      # Execute all tasks in this phase
      - name: implement_phase
        type: agent
        agent: implementer
        context:
          task_file: ${{ inputs.task_file or steps.init.output.task_file_path }}
          phase_name: ${{ item }}
          branch: ${{ inputs.branch_name }}
        metadata:
          progress:
            stage: "implementation"
            phase: ${{ item }}
            weight: 10

      # Validate after each phase (fail fast)
      - name: validate_phase
        type: subworkflow
        workflow: validate-and-fix
        inputs:
          stages:
            - format
            - lint
            - typecheck
            - test
          max_attempts: 2
          fixer_agent: validation_fixer
        metadata:
          progress:
            stage: "validation"
            phase: ${{ item }}
            weight: 5

      # Commit phase changes
      - name: commit_phase
        type: subworkflow
        workflow: commit-and-push
        when: ${{ steps.validate_phase.output.success }}
        inputs:
          push: false
        metadata:
          progress:
            stage: "commit"
            phase: ${{ item }}
            weight: 2

  # ============================================================================
  # Checkpoint: After All Implementation
  # ============================================================================
  # Note: Preflight step now fails hard on errors, so we only reach this
  # checkpoint if all previous steps completed successfully.
  # ============================================================================
  - name: checkpoint_after_implementation
    type: checkpoint
    when: ${{ not inputs.dry_run }}
    checkpoint_id: implementation_complete
    metadata:
      progress:
        stage: "checkpoint"
        weight: 1

  # ============================================================================
  # Stage 4: Commit and Push
  # ============================================================================
  # Final commit (if any uncommitted changes) and push all phase commits to remote.
  # ============================================================================
  - name: commit_and_push
    type: subworkflow
    workflow: commit-and-push
    when: ${{ not inputs.dry_run }}
    metadata:
      progress:
        stage: "commit"
        weight: 10

  # ============================================================================
  # Stage 5: Code Review with Fix Loop
  # ============================================================================
  # Dual-agent code review with automatic issue resolution:
  # 1. Spec Reviewer - Reviews for spec compliance and completeness
  # 2. Technical Reviewer - Reviews for code quality and best practices
  # 3. Fixer Agent - Addresses critical and major issues in parallel
  # ============================================================================
  - name: review
    type: subworkflow
    workflow: review-and-fix
    when: ${{ not inputs.skip_review and not inputs.dry_run }}
    inputs:
      base_branch: main
      max_attempts: 2
      skip_if_approved: true
    metadata:
      progress:
        stage: "review"
        weight: 15

  # ============================================================================
  # Stage 6: Create Pull Request
  # ============================================================================
  # Generate PR body from spec artifacts and create the pull request.
  # ============================================================================
  - name: create_pr
    type: subworkflow
    workflow: create-pr-with-summary
    when: ${{ not inputs.dry_run }}
    inputs:
      base_branch: main
      draft: false
    metadata:
      progress:
        stage: "pr_creation"
        weight: 10

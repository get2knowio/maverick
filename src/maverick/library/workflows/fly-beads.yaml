version: "1.0"
name: fly-beads
description: Bead-driven development workflow — iterates epic beads until done.

inputs:
  epic_id:
    type: string
    required: true
    description: Epic bead ID to iterate over.
  branch_name:
    type: string
    required: true
    description: Git branch for all bead work.
  max_beads:
    type: integer
    required: false
    default: 30
    description: Maximum number of beads to process before stopping.
  dry_run:
    type: boolean
    required: false
    default: false
    description: Preview mode — skip git and bd mutations.
  skip_review:
    type: boolean
    required: false
    default: false
    description: Skip code review step for each bead.

steps:
  - name: preflight
    type: python
    action: run_preflight_checks
    kwargs:
      check_api: true
      check_git: true
      check_bd: true

  - name: init
    type: python
    action: init_workspace
    when: ${{ not inputs.dry_run }}
    kwargs:
      branch_name: ${{ inputs.branch_name }}

  - name: bead_loop
    type: loop
    when: ${{ not inputs.dry_run }}
    until: ${{ steps.check_done.output.done }}
    max_iterations: 30
    steps:
      - name: select_bead
        type: python
        action: select_next_bead
        kwargs:
          epic_id: ${{ inputs.epic_id }}

      - name: implement
        type: agent
        agent: implementer
        when: ${{ steps.select_bead.output.found }}
        context:
          task_description: ${{ steps.select_bead.output.description }}
          branch: ${{ inputs.branch_name }}

      - name: validate
        type: validate
        when: ${{ steps.select_bead.output.found }}
        stages:
          - format
          - lint
          - typecheck
          - test
        retry: 0

      - name: create_fix_beads
        type: python
        action: create_beads_from_failures
        when: ${{ steps.select_bead.output.found }}
        kwargs:
          epic_id: ${{ inputs.epic_id }}
          validation_result: ${{ steps.validate.output }}

      - name: review
        type: agent
        agent: code_reviewer
        when: ${{ steps.select_bead.output.found and not inputs.skip_review }}
        context:
          branch: ${{ inputs.branch_name }}

      - name: create_review_beads
        type: python
        action: create_beads_from_findings
        when: ${{ steps.select_bead.output.found and not inputs.skip_review }}
        kwargs:
          epic_id: ${{ inputs.epic_id }}
          review_result: ${{ steps.review.output }}

      - name: commit_bead
        type: python
        action: git_commit
        when: ${{ steps.select_bead.output.found }}
        kwargs:
          message: "bead(${{ steps.select_bead.output.bead_id }}): ${{ steps.select_bead.output.title }}"

      - name: close_bead
        type: python
        action: mark_bead_complete
        when: ${{ steps.select_bead.output.found }}
        kwargs:
          bead_id: ${{ steps.select_bead.output.bead_id }}

      - name: check_done
        type: python
        action: check_epic_done
        kwargs:
          epic_id: ${{ inputs.epic_id }}

  - name: final_push
    type: python
    action: git_push
    when: ${{ not inputs.dry_run }}

outputs:
  branch: ${{ inputs.branch_name }}
  epic_id: ${{ inputs.epic_id }}

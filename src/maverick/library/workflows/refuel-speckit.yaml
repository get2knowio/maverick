# ==========================================================================
# refuel-speckit: Generate beads from a SpecKit specification directory
# ==========================================================================
#
# Parses tasks.md into coarse-grained beads, uses an LLM to extract
# inter-story dependencies from the free-form "User Story Dependencies"
# section, then creates beads and wires dependencies via the bd CLI.
#
# Usage:
#   maverick fly refuel-speckit -i spec_dir=/path/to/spec
#   maverick fly refuel-speckit -i spec_dir=/path/to/spec -i dry_run=true
#
version: "1.0"
name: refuel-speckit
description: Generate beads from a SpecKit specification directory

inputs:
  spec_dir:
    type: string
    required: true
    description: Path to spec directory containing tasks.md
  dry_run:
    type: boolean
    required: false
    default: false
    description: Preview bead definitions without calling bd

steps:
  # ============================================================================
  # Step 1: Parse Spec Directory
  # ============================================================================
  # Reads tasks.md, classifies phases, groups into bead definitions,
  # enriches with context descriptions, and extracts the dependency section.
  - name: parse_spec
    type: python
    action: parse_speckit
    kwargs:
      spec_dir: ${{ inputs.spec_dir }}
    metadata:
      progress:
        stage: "parse"
        weight: 5

  # ============================================================================
  # Step 2: Extract Dependencies (LLM)
  # ============================================================================
  # Uses DependencyExtractor generator to parse free-form prose into
  # structured [dependent, dependency] pairs. Skipped if no dependency
  # section was found.
  - name: extract_dependencies
    type: generate
    generator: dependency_extractor
    context:
      dependency_section: ${{ steps.parse_spec.output.dependency_section }}
    metadata:
      progress:
        stage: "extract_deps"
        weight: 10

  # ============================================================================
  # Step 3: Create Beads
  # ============================================================================
  # Creates the epic bead and all work beads via bd CLI (or returns
  # synthetic IDs in dry-run mode).
  - name: create_beads
    type: python
    action: create_beads
    kwargs:
      epic_definition: ${{ steps.parse_spec.output.epic_definition }}
      work_definitions: ${{ steps.parse_spec.output.work_definitions }}
      dry_run: ${{ inputs.dry_run }}
    metadata:
      progress:
        stage: "create"
        weight: 15

  # ============================================================================
  # Step 4: Wire Dependencies
  # ============================================================================
  # Computes structural deps (foundation->stories, stories->cleanup) and
  # inter-story deps from the generator output, then wires them via bd CLI.
  # Only runs if the epic was created successfully.
  - name: wire_dependencies
    type: python
    action: wire_dependencies
    when: ${{ steps.create_beads.output.epic }}
    kwargs:
      work_definitions: ${{ steps.parse_spec.output.work_definitions }}
      created_map: ${{ steps.create_beads.output.created_map }}
      tasks_content: ${{ steps.parse_spec.output.tasks_content }}
      extracted_deps: ${{ steps.extract_dependencies.output }}
      dry_run: ${{ inputs.dry_run }}
    metadata:
      progress:
        stage: "wire_deps"
        weight: 10

outputs:
  epic: ${{ steps.create_beads.output.epic }}
  work_beads: ${{ steps.create_beads.output.work_beads }}
  dependencies: ${{ steps.wire_dependencies.output.dependencies }}
  errors: ${{ steps.create_beads.output.errors }}

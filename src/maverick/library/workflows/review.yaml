# ============================================================================
# Review Workflow - Dual-Agent Code Review
# ============================================================================
#
# Purpose:
#   Orchestrates comprehensive code review using two specialized Claude agents:
#   1. Spec Reviewer - Reviews for spec compliance and completeness
#   2. Technical Reviewer - Reviews for technical quality and best practices
#
# Usage:
#   maverick fly review --pr_number 123 --base_branch main
#   maverick fly review  # Auto-detects PR from current branch
#
# Inputs:
#   pr_number (integer, optional):
#     PR number to review. If omitted, auto-detects PR from current branch.
#
#   base_branch (string, optional):
#     Base branch for comparison. Default: "main"
#
#   spec_dir (string, optional):
#     Directory containing spec files for compliance checking.
#     Default: auto-detect from branch name (specs/<branch-name>/)
#
# Steps Overview:
#   1. gather_context: Collect PR metadata, changed files, and spec files
#   2. spec_review: Review for spec compliance and completeness (parallel)
#   3. technical_review: Review for technical quality (parallel)
#   4. combine_results: Merge findings from both reviewers
#
# ============================================================================

version: "1.0"
name: review
description: Dual-agent code review (spec compliance + technical quality)

inputs:
  pr_number:
    type: integer
    required: false
    default: null
    description: PR number (auto-detect if omitted)

  base_branch:
    type: string
    required: false
    default: "main"
    description: Base branch for comparison

  spec_dir:
    type: string
    required: false
    description: |
      Directory containing spec files (auto-detect if omitted).
      Auto-detection searches for specs/<branch-name>/ or ./specs/

steps:
  # ============================================================================
  # Stage 1: Gather Context
  # ============================================================================
  - name: gather_context
    type: python
    action: gather_pr_context
    kwargs:
      pr_number: ${{ inputs.pr_number }}
      base_branch: ${{ inputs.base_branch }}
      include_spec_files: true
      spec_dir: ${{ inputs.spec_dir }}
    metadata:
      progress:
        stage: "gathering_context"
        weight: 10

  # ============================================================================
  # Stage 2: Parallel Reviews
  # ============================================================================
  # Run both review agents in parallel for efficiency
  # ============================================================================
  - name: parallel_reviews
    type: loop
    for_each: ${{ ['spec', 'technical'] }}
    max_concurrency: 2
    steps:
      - name: run_review
        type: agent
        agent: ${{ item }}_reviewer
        context:
          pr_metadata: ${{ steps.gather_context.output.pr_metadata }}
          changed_files: ${{ steps.gather_context.output.changed_files }}
          diff: ${{ steps.gather_context.output.diff }}
          commits: ${{ steps.gather_context.output.commits }}
          spec_files: ${{ steps.gather_context.output.spec_files }}
          base_branch: ${{ inputs.base_branch }}
        metadata:
          progress:
            stage: "review"
            reviewer: ${{ item }}
            weight: 35

  # ============================================================================
  # Stage 3: Combine Results
  # ============================================================================
  - name: combine_results
    type: python
    action: combine_review_results
    kwargs:
      spec_review: ${{ steps.parallel_reviews.output[0] }}
      technical_review: ${{ steps.parallel_reviews.output[1] }}
      pr_metadata: ${{ steps.gather_context.output.pr_metadata }}
    metadata:
      progress:
        stage: "combining_results"
        weight: 20

# =============================================================================
# Review and Fix Fragment
# =============================================================================
#
# Purpose:
#   Orchestrates code review with automatic issue resolution. Runs dual-agent
#   review (spec compliance + technical quality), consolidates findings, and
#   invokes a fixer agent to address issues (which spawns subagents for
#   parallel fixing where possible).
#
# Architecture:
#   ┌─────────────────────────────────────────────────────────┐
#   │                    Review-and-Fix Loop                  │
#   │                                                         │
#   │  ┌──────────────────┐    ┌──────────────────┐          │
#   │  │  Spec Reviewer   │    │ Technical Reviewer│  ← parallel
#   │  │     Agent        │    │      Agent        │          │
#   │  └────────┬─────────┘    └────────┬─────────┘          │
#   │           │                       │                     │
#   │           └───────────┬───────────┘                     │
#   │                       ▼                                 │
#   │              ┌────────────────┐                         │
#   │              │   Consolidate  │                         │
#   │              │    Findings    │                         │
#   │              └────────┬───────┘                         │
#   │                       │                                 │
#   │                       ▼                                 │
#   │              ┌────────────────┐                         │
#   │              │  Issues Found? │─── No ──► Exit (done)   │
#   │              └────────┬───────┘                         │
#   │                       │ Yes                             │
#   │                       ▼                                 │
#   │              ┌────────────────┐                         │
#   │              │  Review Fixer  │  ← single agent that    │
#   │              │     Agent      │    spawns subagents     │
#   │              └────────┬───────┘    for parallel fixes   │
#   │                       │                                 │
#   │                       └──────────► Loop back to top     │
#   │                                                         │
#   └─────────────────────────────────────────────────────────┘
#
# Inputs:
#   - base_branch (string, optional, default: "main")
#     Base branch for PR comparison.
#
#   - max_attempts (integer, optional, default: 2)
#     Maximum review-fix cycles. Set to 0 to disable fixes.
#
#   - skip_if_approved (boolean, optional, default: true)
#     Skip fix loop if initial review recommends "approve".
#
#   - exclude_patterns (array, optional)
#     Glob patterns for files to exclude from review scope.
#     Default: ["specs/**", ".specify/**", ".claude/**", ".github/**"]
#     These patterns exclude tooling/spec files from code review.
#
# Output:
#   ReviewAndFixResult with:
#   - review_report: Final consolidated review report
#   - recommendation: approve | comment | request_changes
#   - issues_found: Total issues identified
#   - issues_fixed: Issues successfully resolved
#   - attempts: Number of fix cycles executed
#
# Used By:
#   - feature workflow (review stage)
#
# =============================================================================

version: "1.0"
name: review-and-fix
description: Code review with automatic issue resolution

inputs:
  base_branch:
    type: string
    required: false
    default: "main"
    description: Base branch for PR comparison

  max_attempts:
    type: integer
    required: false
    default: 2
    description: Maximum review-fix cycles (0 disables fixes)

  skip_if_approved:
    type: boolean
    required: false
    default: true
    description: Skip fix loop if initial review recommends approve

  exclude_patterns:
    type: array
    required: false
    default: ["specs/**", ".specify/**", ".claude/**", ".github/**"]
    description: |
      Glob patterns for files to exclude from review scope.
      Default patterns exclude tooling and spec files that shouldn't be
      modified by the fixer agent. Pass empty array [] to include all files.

steps:
  # ===========================================================================
  # Step 1: Gather PR Context
  # ===========================================================================
  # Collect diff, changed files, and PR metadata for reviewers.
  # ===========================================================================
  - name: gather_context
    type: python
    action: gather_pr_context
    kwargs:
      pr_number: null
      base_branch: ${{ inputs.base_branch }}
      include_spec_files: true
      exclude_patterns: ${{ inputs.exclude_patterns }}
    metadata:
      progress:
        stage: "gathering"
        weight: 5

  # ===========================================================================
  # Step 2: Review-Fix Loop with Report
  # ===========================================================================
  # Execute the review-fix cycle up to max_attempts times.
  # Each iteration:
  # 1. Run both reviewers in parallel
  # 2. Combine findings
  # 3. If approved or no issues, exit loop
  # 4. Run fixer agent (handles parallelization internally)
  #
  # The final report is generated at the end of the loop (folded in).
  # ===========================================================================
  - name: review_fix_loop
    type: python
    action: run_review_fix_loop
    kwargs:
      pr_context: ${{ steps.gather_context.output }}
      base_branch: ${{ inputs.base_branch }}
      max_attempts: ${{ inputs.max_attempts }}
      skip_if_approved: ${{ inputs.skip_if_approved }}
      generate_report: true
    metadata:
      progress:
        stage: "reviewing"
        weight: 85
